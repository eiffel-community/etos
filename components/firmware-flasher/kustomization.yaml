apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
resources:
  - ./resources/role.yaml
  - ./resources/service-account.yaml
  - ./resources/rolebinding.yaml
  - ./resources/service.yaml
  - ./resources/deployment.yaml
  - ./resources/jenkins-secrets.yaml
  - ./resources/autoscaler.yaml

# Having the sealed secret here is a workaround for secrets
# not generating a reload of pods.
# By loading the sealed secret into a generated
# configmap, the configmap will get a new name any time the
# sealed secret is changed resulting in a reload of the
# deployment.
# In order to have this behavior it was either this workaround
# or creating a plugin to kustomize. I chose this since this
# will work natively in ArgoCD.
configMapGenerator:
  - name: etos-firmware-flasher-reloader
    files:
    - ./resources/jenkins-secrets.yaml
  - name: etos-firmware-flasher
    literals:
      - FIRMWARE_FLASH_DEADLINE="600"
      - FIRMWARE_FLASH_DOCKER=docker-prod.se.axis.com/nemesis/suite_runner/firmware_flasher:1.14.0

patches:
- target:
    kind: Deployment
    name: etos-firmware-flasher
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/envFrom/-
      value:
        configMapRef:
          name: etos-firmware-flasher-reloader
- path: ./resources/configmap.yaml
